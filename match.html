<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saisie Match</title>

<style>
:root{
 --bg:#f4f6f9;
 --offense:#ffe0cc;
 --defense:#d6ebff;
 --discipline:#ffd6d6;
 --accent:#1f2937;
}

body{
 font-family:Segoe UI,sans-serif;
 margin:0;
 background:var(--bg);
 padding:10px;
}

h3{
 margin:5px 0 10px 0;
}

button{
 padding:8px 12px;
 border:none;
 border-radius:6px;
 cursor:pointer;
 font-weight:600;
 margin-bottom:10px;
}

.grid{
 display:grid;
 grid-template-columns:140px repeat(3,1fr);
 gap:8px;
}

.cell{
 border-radius:10px;
 position:relative;
 display:flex;
 justify-content:center;
 align-items:center;
 min-height:85px;
 font-weight:600;
 cursor:pointer;
 transition:0.1s;
}

.cell:hover{
 transform:scale(1.03);
}

.cell.flash{
 background:#22c55e!important;
 color:white;
}

.minus{
 position:absolute;
 top:6px;
 left:6px;
 font-size:18px;
 font-weight:bold;
 background:rgba(255,255,255,0.7);
 padding:2px 6px;
 border-radius:6px;
}

.counter{
 position:absolute;
 bottom:6px;
 right:8px;
 font-size:16px;
 opacity:.6;
}

.header-row{
 text-align:center;
 font-weight:700;
}

.category-offense{ background:var(--offense); }
.category-defense{ background:var(--defense); }
.category-discipline{ background:var(--discipline); }

/* Responsive téléphone simple */
@media(max-width:600px){
 .grid{
  grid-template-columns:100px repeat(3,1fr);
 }
 .cell{
  min-height:70px;
  font-size:14px;
 }
}
</style>
</head>

<body>

<h3 id="context"></h3>
<button onclick="endMatch()">Fin & Export</button>

<div class="grid" id="grid"></div>

<script>

let team=JSON.parse(localStorage.getItem("current_team"));
if(!team){window.location.href="index.html"}

let tournament=localStorage.getItem("tournament_id");
let phase=localStorage.getItem("phase");
let matchNumber=localStorage.getItem("match_number");
let station=localStorage.getItem("station_id");

document.getElementById("context").textContent=
`${tournament} | ${phase} | Match ${matchNumber} | Station ${station}`;

let log=[];

const CRITERES=[
 "SHOT","ASSIST","GOAL",
 "SAVE","RECOVERY",
 "FOUL"
];

const RULES={GOAL:["SHOT"]};

const grid=document.getElementById("grid");

grid.innerHTML="<div></div>"+
 team.map(p=>`<div class="header-row"><strong>${p.display_name||p.full_name}</strong></div>`).join("");

CRITERES.forEach(c=>{
 grid.innerHTML+=`<div>${c}</div>`;
 team.forEach(p=>{
  grid.innerHTML+=`
  <div class="cell ${getCategoryClass(c)}"
   onclick="addEvent('${p.id}','${c}',this)">
   <span class="minus"
    onclick="removeEvent(event,'${p.id}','${c}',this)">−</span>
   <span class="counter">0</span>
  </div>`;
 });
});

function getCategoryClass(critere){
 if(["SHOT","ASSIST","GOAL"].includes(critere))
   return "category-offense";
 if(["SAVE","RECOVERY"].includes(critere))
   return "category-defense";
 return "category-discipline";
}

function addEvent(playerId,critere,el){
 processEvent(playerId,critere,el);
 if(RULES[critere]){
  RULES[critere].forEach(dep=>{
   const depCell=findCell(playerId,dep);
   processEvent(playerId,dep,depCell);
  });
 }
}

function processEvent(playerId,critere,el){
 log.push({
  timestamp:new Date().toISOString(),
  tournament,
  phase,
  matchNumber,
  station,
  player_id:playerId,
  critere
 });
 el.querySelector(".counter").textContent++;
 el.classList.add("flash");
 setTimeout(()=>el.classList.remove("flash"),120);
}

function removeEvent(e,playerId,critere,minusEl){
 e.stopPropagation();
 const cell=minusEl.parentElement;
 for(let i=log.length-1;i>=0;i--){
  if(log[i].player_id===playerId&&log[i].critere===critere){
   log.splice(i,1);
   let c=cell.querySelector(".counter");
   if(c.textContent>0)c.textContent--;
   break;
  }
 }
}

function findCell(playerId,critere){
 const rows=[...grid.children];
 for(let i=0;i<rows.length;i++){
  if(rows[i].textContent===critere){
   return rows[i+1+team.findIndex(p=>p.id===playerId)];
  }
 }
}

function endMatch(){
 let csv="timestamp,tournament,phase,match,station,player_id,critere\n";
 log.forEach(e=>{
  csv+=`${e.timestamp},${e.tournament},${e.phase},${e.matchNumber},${e.station},${e.player_id},${e.critere}\n`;
 });
 const blob=new Blob([csv],{type:"text/csv"});
 const url=URL.createObjectURL(blob);
 const a=document.createElement("a");
 a.href=url;
 a.download=`${matchNumber}_${station}.csv`;
 a.click();
 log=[];
}

</script>

</body>
</html>
